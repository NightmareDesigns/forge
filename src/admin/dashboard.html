<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CraftForge Admin - License Manager</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0d0000 0%, #1a0000 100%);
      color: #cccccc;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: rgba(13, 0, 0, 0.9);
      border-bottom: 2px solid #8b0000;
      padding: 20px 0;
      margin-bottom: 30px;
    }

    header h1 {
      color: #8b0000;
      font-size: 32px;
      margin-bottom: 5px;
    }

    header p {
      color: #aaa;
      font-size: 14px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid #444;
      padding-bottom: 10px;
    }

    .tab-btn {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: #aaa;
      cursor: pointer;
      font-size: 14px;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
    }

    .tab-btn:hover {
      color: #ccc;
    }

    .tab-btn.active {
      color: #8b0000;
      border-bottom-color: #8b0000;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background: rgba(26, 0, 0, 0.8);
      border: 1px solid #444;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-box {
      background: rgba(139, 0, 0, 0.1);
      border: 1px solid #8b0000;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }

    .stat-box h3 {
      color: #8b0000;
      font-size: 28px;
      margin-bottom: 5px;
    }

    .stat-box p {
      color: #aaa;
      font-size: 12px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      color: #ccc;
      font-size: 13px;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid #555;
      border-radius: 4px;
      color: #ccc;
      font-size: 13px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #8b0000;
      background: rgba(139, 0, 0, 0.05);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    button {
      padding: 10px 20px;
      background: #8b0000;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    button:hover {
      background: #a00000;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-group {
      display: flex;
      gap: 10px;
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid #555;
      color: #aaa;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: rgba(139, 0, 0, 0.1);
      border-bottom: 2px solid #8b0000;
    }

    th {
      padding: 12px;
      text-align: left;
      color: #8b0000;
      font-weight: 600;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #333;
    }

    tbody tr:hover {
      background: rgba(139, 0, 0, 0.05);
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-success {
      background: rgba(0, 200, 100, 0.2);
      color: #00c864;
    }

    .badge-warning {
      background: rgba(255, 200, 0, 0.2);
      color: #ffc800;
    }

    .badge-danger {
      background: rgba(255, 0, 0, 0.2);
      color: #ff4444;
    }

    .message {
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      display: none;
    }

    .message.success {
      background: rgba(0, 200, 100, 0.1);
      border: 1px solid #00c864;
      color: #00c864;
      display: block;
    }

    .message.error {
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid #ff4444;
      color: #ff4444;
      display: block;
    }

    .copy-btn {
      padding: 5px 10px;
      font-size: 11px;
      background: rgba(139, 0, 0, 0.5);
      margin-left: 5px;
    }

    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .search-box input {
      flex: 1;
      padding: 10px;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid #555;
      border-radius: 4px;
      color: #ccc;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #1a0000;
      border: 2px solid #8b0000;
      border-radius: 8px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-content h2 {
      color: #8b0000;
      margin-bottom: 20px;
    }

    .close-modal {
      float: right;
      font-size: 24px;
      color: #8b0000;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
    }

    .close-modal:hover {
      color: #ccc;
    }

    .code-block {
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid #555;
      border-radius: 4px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      margin: 10px 0;
      word-break: break-all;
      color: #00ff00;
    }

    .email-template {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid #555;
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 12px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>üîê CraftForge Admin License Manager</h1>
      <p>Master license system for customer management and key distribution</p>
    </div>
  </header>

  <div class="container">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
      <button class="tab-btn" onclick="switchTab('register')">Register Payment</button>
      <button class="tab-btn" onclick="switchTab('customers')">Customers</button>
      <button class="tab-btn" onclick="switchTab('search')">Search</button>
      <button class="tab-btn" onclick="switchTab('tools')">Tools</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
      <div class="card">
        <h2>Statistics</h2>
        <div class="stats-grid" id="statsGrid">
          <div class="stat-box">
            <h3>-</h3>
            <p>Total Licenses</p>
          </div>
          <div class="stat-box">
            <h3>-</h3>
            <p>Active Licenses</p>
          </div>
          <div class="stat-box">
            <h3>-</h3>
            <p>Total Customers</p>
          </div>
          <div class="stat-box">
            <h3>-</h3>
            <p>Total Revenue</p>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>License Distribution</h2>
        <div id="licenseBreakdown"></div>
      </div>
    </div>

    <!-- Register Payment Tab -->
    <div id="register" class="tab-content">
      <div class="card">
        <h2>Register Customer Payment</h2>
        <div id="registerMessage" class="message"></div>
        
        <form onsubmit="registerPayment(event)">
          <div class="form-group">
            <label>Customer Email *</label>
            <input type="email" id="customerEmail" placeholder="customer@example.com" required>
          </div>

          <div class="form-group">
            <label>Customer Name *</label>
            <input type="text" id="customerName" placeholder="John Doe" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Product Type</label>
              <select id="productType">
                <option value="CraftForge">CraftForge</option>
                <option value="CraftForge Pro">CraftForge Pro</option>
              </select>
            </div>

            <div class="form-group">
              <label>License Type</label>
              <select id="licenseType">
                <option value="trial">Trial (30 days)</option>
                <option value="personal">Personal (1 year)</option>
                <option value="professional">Professional (2 years)</option>
                <option value="enterprise">Enterprise (5 years)</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Payment Amount</label>
              <input type="number" id="paymentAmount" placeholder="0.00" step="0.01" value="0">
            </div>

            <div class="form-group">
              <label>Payment Method</label>
              <select id="paymentMethod">
                <option value="stripe">Stripe</option>
                <option value="paypal">PayPal</option>
                <option value="manual">Manual</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <button type="submit">Register Payment & Generate Keys</button>
        </form>

        <div id="registrationResult" style="display: none; margin-top: 20px;">
          <div class="card" style="background: rgba(0, 200, 100, 0.05); border-color: #00c864;">
            <h3 style="color: #00c864;">‚úì License Generated Successfully</h3>
            <div class="code-block" id="resultSoftwareNumber"></div>
            <p style="margin: 10px 0; color: #aaa;">Share this software number with customer via email</p>
            
            <div class="code-block" id="resultLicenseKey"></div>
            <p style="margin: 10px 0; color: #aaa;">Send this when customer requests it with their software number</p>

            <h4 style="color: #8b0000; margin-top: 20px;">Email Template:</h4>
            <div class="email-template" id="emailTemplate"></div>

            <button onclick="copyToClipboard('resultSoftwareNumber')" class="copy-btn">Copy Software Number</button>
            <button onclick="copyToClipboard('resultLicenseKey')" class="copy-btn">Copy License Key</button>
            <button onclick="copyToClipboard('emailTemplate')" class="copy-btn">Copy Email</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Customers Tab -->
    <div id="customers" class="tab-content">
      <div class="card">
        <h2>All Customers</h2>
        <button onclick="loadCustomers()" style="margin-bottom: 15px;">üîÑ Refresh</button>
        <table id="customersTable">
          <thead>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th>Software Number</th>
              <th>Status</th>
              <th>License Type</th>
              <th>Amount</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="customersBody">
            <tr>
              <td colspan="7" style="text-align: center; color: #aaa;">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Search Tab -->
    <div id="search" class="tab-content">
      <div class="card">
        <h2>Search Customers</h2>
        <div class="search-box">
          <input type="text" id="searchQuery" placeholder="Search by email, name, or software number..." onkeyup="searchCustomers()">
          <button onclick="searchCustomers()">Search</button>
        </div>

        <div id="searchResults" style="display: none;">
          <h3 style="color: #8b0000; margin-bottom: 15px;" id="searchResultsCount"></h3>
          <table id="searchResultsTable">
            <thead>
              <tr>
                <th>Email</th>
                <th>Name</th>
                <th>Software Number</th>
                <th>License Key</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="searchResultsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tools Tab -->
    <div id="tools" class="tab-content">
      <div class="card">
        <h2>Admin Tools</h2>
        
        <div style="margin-bottom: 20px;">
          <h3 style="color: #8b0000; margin-bottom: 10px;">Get License Key by Software Number</h3>
          <div class="form-row">
            <input type="text" id="toolSoftwareNumber" placeholder="e.g., NM-XXXX-XXXX" style="padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid #555; border-radius: 4px;">
            <button onclick="getLicenseKey()">Get License Key</button>
          </div>
          <div id="toolResult" class="message" style="margin-top: 15px;"></div>
        </div>

        <div style="border-top: 1px solid #444; padding-top: 20px;">
          <h3 style="color: #8b0000; margin-bottom: 10px;">Export Options</h3>
          <div class="btn-group">
            <button onclick="exportCSV()">üì• Export as CSV</button>
            <button onclick="exportJSON()">üì• Export as JSON</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for customer details -->
  <div id="customerModal" class="modal">
    <div class="modal-content">
      <button class="close-modal" onclick="closeModal()">√ó</button>
      <h2 id="modalTitle"></h2>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';
    const AUTH_TOKEN = 'admin-master-key-2026';

    function getHeaders() {
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${AUTH_TOKEN}`
      };
    }

    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');

      // Load data for certain tabs
      if (tabName === 'dashboard') {
        loadStatistics();
      } else if (tabName === 'customers') {
        loadCustomers();
      }
    }

    function loadStatistics() {
      fetch(`${API_URL}/statistics`, { headers: getHeaders() })
        .then(r => r.json())
        .then(data => {
          const grid = document.getElementById('statsGrid');
          grid.innerHTML = `
            <div class="stat-box">
              <h3>${data.totalLicenses}</h3>
              <p>Total Licenses</p>
            </div>
            <div class="stat-box">
              <h3>${data.activeLicenses}</h3>
              <p>Active Licenses</p>
            </div>
            <div class="stat-box">
              <h3>${data.totalCustomers}</h3>
              <p>Total Customers</p>
            </div>
            <div class="stat-box">
              <h3>$${data.totalRevenue.toFixed(2)}</h3>
              <p>Total Revenue</p>
            </div>
          `;

          let breakdown = '<ul style="color: #aaa;">';
          for (const [type, count] of Object.entries(data.licensesByType)) {
            breakdown += `<li>${type}: ${count}</li>`;
          }
          breakdown += '</ul>';
          document.getElementById('licenseBreakdown').innerHTML = breakdown;
        });
    }

    function registerPayment(e) {
      e.preventDefault();

      const data = {
        email: document.getElementById('customerEmail').value,
        name: document.getElementById('customerName').value,
        productType: document.getElementById('productType').value,
        licenseType: document.getElementById('licenseType').value,
        paymentAmount: parseFloat(document.getElementById('paymentAmount').value),
        paymentMethod: document.getElementById('paymentMethod').value
      };

      const msgDiv = document.getElementById('registerMessage');
      msgDiv.className = 'message';

      fetch(`${API_URL}/register-payment`, {
        method: 'POST',
        headers: getHeaders(),
        body: JSON.stringify(data)
      })
        .then(r => r.json())
        .then(result => {
          if (result.error) {
            msgDiv.className = 'message error';
            msgDiv.textContent = `‚ùå ${result.error}`;
          } else {
            msgDiv.className = 'message success';
            msgDiv.textContent = `‚úì ${result.message}`;

            // Show results
            const resultDiv = document.getElementById('registrationResult');
            document.getElementById('resultSoftwareNumber').textContent = result.softwareNumber;
            document.getElementById('resultLicenseKey').textContent = result.licenseKey;

            const emailTemplate = `Dear ${result.name},

Thank you for your purchase of ${data.productType}!

Your Software Number is:
${result.softwareNumber}

To activate your license, please use this software number when prompted in the application.

Once you enter the software number, you will receive your license key via email.

Best regards,
Nightmare Designs Team
support@nightmaredesigns.org`;

            document.getElementById('emailTemplate').textContent = emailTemplate;
            resultDiv.style.display = 'block';

            // Reset form
            document.getElementById('registerPayment').reset();
          }
        })
        .catch(err => {
          msgDiv.className = 'message error';
          msgDiv.textContent = `‚ùå Error: ${err.message}`;
        });
    }

    function loadCustomers() {
      fetch(`${API_URL}/customers`, { headers: getHeaders() })
        .then(r => r.json())
        .then(customers => {
          const tbody = document.getElementById('customersBody');
          tbody.innerHTML = '';

          if (customers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #aaa;">No customers yet</td></tr>';
            return;
          }

          customers.forEach(customer => {
            const statusBadge = customer.activated ? 
              '<span class="badge badge-success">Active</span>' : 
              '<span class="badge badge-warning">Inactive</span>';

            tbody.innerHTML += `
              <tr>
                <td>${customer.email}</td>
                <td>${customer.name}</td>
                <td><code>${customer.softwareNumber}</code></td>
                <td>${statusBadge}</td>
                <td>${customer.licenseType}</td>
                <td>$${customer.paymentAmount.toFixed(2)}</td>
                <td>
                  <button class="btn-secondary" onclick="showCustomerDetails('${customer.softwareNumber}')" style="padding: 5px 10px; font-size: 12px;">View</button>
                  <button class="btn-secondary" onclick="resendKey('${customer.softwareNumber}')" style="padding: 5px 10px; font-size: 12px;">Resend Key</button>
                </td>
              </tr>
            `;
          });
        })
        .catch(err => console.error('Error:', err));
    }

    function searchCustomers() {
      const query = document.getElementById('searchQuery').value;
      if (!query) {
        document.getElementById('searchResults').style.display = 'none';
        return;
      }

      fetch(`${API_URL}/search?q=${encodeURIComponent(query)}`, { headers: getHeaders() })
        .then(r => r.json())
        .then(results => {
          const resultsDiv = document.getElementById('searchResults');
          const tbody = document.getElementById('searchResultsBody');

          document.getElementById('searchResultsCount').textContent = `Found ${results.length} result(s)`;
          tbody.innerHTML = '';

          if (results.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #aaa;">No results found</td></tr>';
          } else {
            results.forEach(customer => {
              const licenseKey = customer.licenseInfo?.licenseKey || 'N/A';
              const statusBadge = customer.activated ? 
                '<span class="badge badge-success">Active</span>' : 
                '<span class="badge badge-warning">Inactive</span>';

              tbody.innerHTML += `
                <tr>
                  <td>${customer.email}</td>
                  <td>${customer.name}</td>
                  <td><code>${customer.softwareNumber}</code></td>
                  <td><code style="font-size: 11px;">${licenseKey}</code></td>
                  <td>${statusBadge}</td>
                  <td>
                    <button class="btn-secondary" onclick="copyToClipboard('${licenseKey}')" style="padding: 5px 10px; font-size: 12px;">Copy Key</button>
                  </td>
                </tr>
              `;
            });
          }

          resultsDiv.style.display = 'block';
        });
    }

    function showCustomerDetails(softwareNumber) {
      fetch(`${API_URL}/customer/${softwareNumber}`, { headers: getHeaders() })
        .then(r => r.json())
        .then(customer => {
          const modal = document.getElementById('customerModal');
          document.getElementById('modalTitle').textContent = customer.name;
          document.getElementById('modalBody').innerHTML = `
            <p><strong>Email:</strong> ${customer.email}</p>
            <p><strong>Software Number:</strong> <code>${customer.softwareNumber}</code></p>
            <p><strong>License Key:</strong> <code>${customer.licenseInfo?.licenseKey || 'N/A'}</code></p>
            <p><strong>Product:</strong> ${customer.productType}</p>
            <p><strong>License Type:</strong> ${customer.licenseType}</p>
            <p><strong>Status:</strong> ${customer.activated ? '‚úì Active' : '‚úó Inactive'}</p>
            <p><strong>Payment Amount:</strong> $${customer.paymentAmount.toFixed(2)}</p>
            <p><strong>Payment Date:</strong> ${new Date(customer.paymentDate).toLocaleDateString()}</p>
            <p><strong>Expiry Date:</strong> ${new Date(customer.expiryDate).toLocaleDateString()}</p>
          `;
          modal.classList.add('active');
        });
    }

    function closeModal() {
      document.getElementById('customerModal').classList.remove('active');
    }

    function getLicenseKey() {
      const softwareNumber = document.getElementById('toolSoftwareNumber').value;
      if (!softwareNumber) {
        alert('Please enter a software number');
        return;
      }

      const resultDiv = document.getElementById('toolResult');
      fetch(`${API_URL}/license/${softwareNumber}`, { headers: getHeaders() })
        .then(r => r.json())
        .then(data => {
          if (data.error) {
            resultDiv.className = 'message error';
            resultDiv.textContent = `‚ùå ${data.error}`;
          } else {
            resultDiv.className = 'message success';
            resultDiv.innerHTML = `
              ‚úì <strong>${data.email}</strong><br>
              License Key: <code>${data.licenseKey}</code><br>
              Expires: ${new Date(data.expiryDate).toLocaleDateString()}
            `;
          }
        });
    }

    function resendKey(softwareNumber) {
      if (confirm('Resend license key to customer?')) {
        fetch(`${API_URL}/resend-key/${softwareNumber}`, {
          method: 'POST',
          headers: getHeaders()
        })
          .then(r => r.json())
          .then(data => {
            alert(`‚úì License key resent to ${data.email}`);
          });
      }
    }

    function copyToClipboard(elementId) {
      const text = document.getElementById(elementId).textContent;
      navigator.clipboard.writeText(text).then(() => {
        alert('‚úì Copied to clipboard!');
      });
    }

    function exportCSV() {
      window.open(`${API_URL}/export/csv`, '_blank');
    }

    function exportJSON() {
      fetch(`${API_URL}/customers`, { headers: getHeaders() })
        .then(r => r.json())
        .then(data => {
          const json = JSON.stringify(data, null, 2);
          const blob = new Blob([json], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'licenses.json';
          a.click();
        });
    }

    // Load stats on page load
    window.addEventListener('load', () => {
      loadStatistics();
    });
  </script>
</body>
</html>
